<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Money Manager Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="logo_app_96.png">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <!-- Logo Section -->
            <div class="logo-section">
                <img src="logo_app_96.png" alt="Money Manager Logo" class="app-logo">
                <div class="app-info">
                    <h1>Money Manager</h1>
                    <p>Employee Dashboard</p>
                </div>
            </div>

            <div class="login-header">
                <h2>Employee Login</h2>
                <p>Enter your credentials to access the dashboard</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="email">
                        <i class="fas fa-envelope"></i>
                        Email Address
                    </label>
                    <input type="email" id="email" required 
                           placeholder="employee@company.com">
                </div>

                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-lock"></i>
                        Password
                    </label>
                    <input type="password" id="password" required 
                           placeholder="Enter your password">
                </div>

                <button type="submit" class="btn btn-primary btn-block login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In
                </button>

                <div class="login-footer">
                    <p class="error-message" id="errorMessage"></p>
                    <p class="footer-note">Authorized employees only</p>
                    
                    <!-- Quick Help Button -->
                    <button type="button" class="btn btn-secondary btn-block" id="quickHelpBtn">
                        <i class="fas fa-magic"></i> Quick Setup: Create Test Admin
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK (Compatibility Version) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Configuration and Auth -->
    <script src="firebase-config.js"></script>
    <script>
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Check if user is already logged in
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    // Check if user exists in employees collection
                    const employeeDoc = await firebase.firestore()
                        .collection('employees')
                        .doc(user.uid)
                        .get();
                    
                    if (employeeDoc.exists) {
                        window.location.href = 'dashboard.html';
                    } else {
                        // User is not an employee, sign them out
                        await firebase.auth().signOut();
                        showError('Access denied. You are not registered as an employee.');
                    }
                } catch (error) {
                    console.error('Auth check error:', error);
                }
            }
        });

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const loginBtn = document.querySelector('.login-btn');
            
            // Show loading state
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            loginBtn.disabled = true;
            errorMessage.textContent = '';
            
            try {
                // Sign in with Firebase Auth
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                const userId = userCredential.user.uid;
                
                // Verify employee exists in employees collection
                const employeeDoc = await firebase.firestore()
                    .collection('employees')
                    .doc(userId)
                    .get();
                
                if (!employeeDoc.exists) {
                    // User is not an employee
                    await firebase.auth().signOut();
                    showError('Access denied. You are not registered as an employee.');
                    return;
                }
                
                // Login successful, redirect to dashboard
                window.location.href = 'dashboard.html';
                
            } catch (error) {
                let errorMsg = 'Login failed. Please try again.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMsg = 'Invalid email or password.';
                        break;
                    case 'auth/invalid-email':
                        errorMsg = 'Please enter a valid email address.';
                        break;
                    case 'auth/user-disabled':
                        errorMsg = 'This account has been disabled.';
                        break;
                    case 'auth/too-many-requests':
                        errorMsg = 'Too many failed attempts. Please try again later.';
                        break;
                }
                
                showError(errorMsg);
            } finally {
                // Restore button state
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        });

        // Quick Help Button - Create Test Admin
        document.getElementById('quickHelpBtn').addEventListener('click', async function() {
            const email = 'admin@moneymanager.com';
            const password = 'Admin@1234';
            const errorMessage = document.getElementById('errorMessage');
            
            // Change button state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            this.disabled = true;
            
            try {
                errorMessage.textContent = 'Creating admin account...';
                
                // 1. Create auth account
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;
                
                errorMessage.textContent = 'Account created, adding employee data...';
                
                // 2. Add to employees collection
                await firebase.firestore().collection('employees').doc(uid).set({
                    name: 'System Administrator',
                    email: email,
                    phone: '+966501234567',
                    role: 'Admin',
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                errorMessage.textContent = 'âœ… Success! Auto-filling credentials...';
                
                // 3. Auto-fill form
                document.getElementById('email').value = email;
                document.getElementById('password').value = password;
                
                // 4. Auto login after 2 seconds
                setTimeout(async () => {
                    try {
                        await firebase.auth().signInWithEmailAndPassword(email, password);
                        window.location.href = 'dashboard.html';
                    } catch (loginError) {
                        errorMessage.textContent = 'Please click "Sign In" button.';
                    }
                    
                    // Restore button
                    this.innerHTML = originalText;
                    this.disabled = false;
                }, 2000);
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage.textContent = 'âœ… Account already exists. Use: ' + email + ' / ' + password;
                    document.getElementById('email').value = email;
                    document.getElementById('password').value = password;
                } else {
                    errorMessage.textContent = 'Error: ' + error.message;
                }
                
                // Restore button
                this.innerHTML = originalText;
                this.disabled = false;
            }
        });

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
        }

        // Developer tools message
        console.log('%cðŸ”§ Money Manager Dashboard', 'color: #018159; font-size: 16px; font-weight: bold;');
        console.log('%cFor development tools, check the console for useful functions.', 'color: #666;');
    </script>
</body>
</html>